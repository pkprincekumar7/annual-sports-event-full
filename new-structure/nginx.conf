upstream identity_service {
    server identity-service:8001;
}

upstream enrollment_service {
    server enrollment-service:8002;
}

upstream organization_service {
    server organization-service:8003;
}

upstream sports_participation_service {
    server sports-participation-service:8004;
}

upstream event_configuration_service {
    server event-configuration-service:8005;
}

upstream scheduling_service {
    server scheduling-service:8006;
}

upstream scoring_service {
    server scoring-service:8007;
}

upstream reporting_service {
    server reporting-service:8008;
}

upstream frontend_app {
    server frontend:80;
}

server {
    listen 80;

    location ~ ^/api/(login|change-password|reset-password|me|players|save-player|update-player|bulk-player-enrollments|delete-player|bulk-delete-players)(/|$) {
        proxy_pass http://identity_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location ~ ^/api/(add-batch|remove-batch|batches)(/|$) {
        proxy_pass http://enrollment_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location ~ ^/api/departments(/|$) {
        proxy_pass http://organization_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location ~ ^/api/(sports|sports-counts|participants|participants-count|teams|update-team-participation|update-team-player|delete-team|validate-participations|update-participation|remove-participation|add-captain|remove-captain|captains-by-sport|add-coordinator|remove-coordinator|coordinators-by-sport|player-enrollments)(/|$) {
        proxy_pass http://sports_participation_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location ~ ^/api/event-years(/|$) {
        proxy_pass http://event_configuration_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location ~ ^/api/event-schedule(/|$) {
        proxy_pass http://scheduling_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location ~ ^/api/(points-table|internal/points-table/update)(/|$) {
        proxy_pass http://scoring_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location ~ ^/api/export-excel(/|$) {
        proxy_pass http://reporting_service;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location /api/ {
        return 404;
    }

    location / {
        proxy_pass http://frontend_app;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }
}
